from json import detect_encoding
from requests.models import PreparedRequest
import threading
import requests
import time
import math


ctokenstr = input("Input Collection Tokens (SSV):")
ctokens = ctokenstr.split(" ")
listing_prices = {"collections":{}} # Format: Collection Token > Serial:Price {"collections":{"0x...": {"123": 1.3}}}
collection_data = {"collections":{}}
proxies = [
    "https://1-1.fruitbarrel.repl.co", 
    "https://2-1.fruitbarrel.repl.co", 
    "https://3-1.fruitbarrel.repl.co",
    "https://4-1.fruitbarrel.repl.co",
    "https://5-1.fruitbarrel.repl.co",
    "https://6-1.fruitbarrel.repl.co",
    "https://7-1.fruitbarrel.repl.co",
    "https://8-1.fruitbarrel.repl.co",
    "https://9-1.fruitbarrel.repl.co",
    "https://10-1.fruitbarrel.repl.co",
    "https://11-1.fruitbarrel.repl.co",
    "https://12-1.fruitbarrel.repl.co",
    "https://13-1.fruitbarrel.repl.co",
    "https://14-1.fruitbarrel.repl.co",
    "https://15-1.fruitbarrel.repl.co",
    "https://16-1.fruitbarrel.repl.co",
    "https://17-1.fruitbarrel.repl.co",
    "https://18-1.fruitbarrel.repl.co",
    "https://19-1.fruitbarrel.repl.co",
    "https://20-1.fruitbarrel.repl.co"
]
payload_index = -1
proxy_index = 0
reqs_active = 0
done = True


def get_count(ctoken):
    request = requests.get(F"https://api.opensea.io/api/v1/assets?asset_contract_address={ctoken}&order_direction=desc")
    highest_serial = request.json()["assets"][0]["token_id"]
    
    return highest_serial

    
def get_payloads(ctoken):
    payloads = []
    count = int(get_count(ctoken))

    for index in range(0, count, 30):
        sub = []
        for idx in range(30):
            sub.append(index + idx)
        payloads.append(sub)

    return payloads


def get_listed_serials_thread(ctoken, payloads):
    global done
    global reqs_active
    global payload_index
    global proxy_index

    listing_prices["collections"][ctoken] = []
    collection_name = ""
    collection_desc = ""
    detected = []
    
    while payload_index < len(payloads):
        print(payloads[payload_index])

        url = "https://api.opensea.io/wyvern/v1/orders"
        params = {"asset_contract_address":ctoken,"is_english":"false","bundled":"false","include_bundled":"false","include_invalid":"false","token_ids":payloads[payload_index],"side":"1","limit":"50","offset":"0","order_by":"created_date","order_direction":"desc"}
        req = PreparedRequest()
        req.prepare_url(url, params)

        proxy_index += 1
        if proxy_index > len(proxies) - 1:
            proxy_index = 0

        print(proxy_index)
        payload_index += 1

        reqs_active += 1
        request = requests.get(F"{proxies[proxy_index]}/proxy?url=~{req.url}~")
        reqs_active -= 1
        
        print("ReqDone")

        for order in request.json()["orders"]:
            collection_name = order["asset"]["asset_contract"]["name"]
            collection_desc = order["asset"]["asset_contract"]["description"]
            if order["asset"]["token_id"] not in detected:
                detected.append(order["asset"]["token_id"])
                listing_prices["collections"][ctoken].append(float(order["current_price"]) / pow(10, 18))

    collection_data["collections"][c]["collection_name"] = collection_name
    collection_data["collections"][c]["collection_desc"] = collection_desc
    collection_data["collections"][c]["listed_serials"] += detected
    
    if reqs_active <= 0:
        done = True
        print("done")



def get_listed_serials(ctoken, payloads):
    global done
    done = False

    for index in range(math.floor(len(proxies)/2.5)):
        print(index, )
        thread = threading.Thread(target=get_listed_serials_thread, args=(ctoken, payloads))
        thread.start()
        time.sleep(0.5)

    while not done:
        time.sleep(1)



def get_highest_bids(ctoken, listed_serials, basic_payloads):
    detected = {}
    count = {}
    majority_bids = {}
    payloads = []

    print(len(listed_serials), "serials")
    print(len(list(dict.fromkeys(listed_serials))))

    for basic_payload in basic_payloads:
        payload = []
        for index in basic_payload:
            if index < len(listed_serials):
                payload.append(listed_serials[index])
            else:
                break
        if len(payload) > 0:
            payloads.append(payload)

    print(len(payloads))

    for payload in payloads:
        print(payload)

        url = "https://api.opensea.io/wyvern/v1/orders"
        querystring = {"asset_contract_address":ctoken,"is_english":"false","bundled":"false","include_bundled":"false","include_invalid":"false","token_ids":payload,"side":"0","limit":"50","offset":"0","order_by":"eth_price","order_direction":"desc"}
        headers = {"Accept": "application/json"}
        request = requests.request("GET", url, headers=headers, params=querystring)

        for order in request.json()["orders"]:
            if order["asset"]["token_id"] not in detected:
                detected[order["asset"]["token_id"]] = order["base_price"]

        time.sleep(0.6)
    
    for key, value in detected.items():
        if value in count:
            count[value] = count[value] + 1
        else:
            count[value] = 1
    
    print(detected)
    print((len(detected) / len(listed_serials)) * 100, "% Of listings have bids")
    collection_data["collections"][ctoken]["bid_to_listing_rato"] = len(detected) / len(listed_serials)

    for key, value in count.items():
        if value/len(listed_serials) >= 0.1:
            majority_bids[key] = value
            print(key, "Bid is found on", value/len(listed_serials)*100, "percent of listings")
    # GET FLOOR AND COMPARE BID TO FLOOR

    floor_price = 0

    for price in listing_prices["collections"][ctoken]:
        if price < floor_price or floor_price == 0:
            floor_price = price
            print(floor_price)

    print()
    print(listing_prices)
    print("Floor Price: ", floor_price)
    override = input("Override Floor Price? (y/n): ")
    if override == "y":
        floor_price = float(input("Enter Desired Floor Price: "))
        
    collection_data["collections"][ctoken]["floor_price"] = floor_price
    collection_data["collections"][ctoken]["bid_count"] = len(detected.items())


    ratios = [0.05, 0.1, 0.15, 0.20, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1.0]
    for ratio in ratios:
        theoretical_bid = floor_price * ratio
        beat_bids_count = 0
        for key, value in detected.items():
            if theoretical_bid > int(value) / pow(10, 18):
                beat_bids_count += 1
        collection_data["collections"][ctoken][str(ratio)+"_bbc"] = beat_bids_count
        print("Bid", ratio*100, "% Of floor to beat", beat_bids_count/len(detected.items())*100, "% Of bids")


    print(majority_bids)
    print(collection_data)
        


for c in ctokens:
    payloads = get_payloads(c)
    collection_data["collections"][c] = {}
    collection_data["collections"][c]["listed_serials"] = []

    get_listed_serials(c, payloads)

    collection_data["collections"][c]["listed_serials"] = list(dict.fromkeys(collection_data["collections"][c]["listed_serials"]))
    get_highest_bids(c, collection_data["collections"][c]["listed_serials"], payloads)

